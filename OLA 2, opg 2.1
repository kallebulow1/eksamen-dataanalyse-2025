library(readxl)
library(dplyr)
forbtillidDI <- read_excel("data/forbtillidDI.xlsx")
privatforbrug <- read_excel("data/privatforbrug.xlsx")

library(dkstat)
library(tidyr)
library(stringr)

# opgave 2.1
# hent meta data
forv1meta <- dst_meta(table = "FORV1", lang = "da")

# lav query med søgekriterier
forv_query <- list(
  INDIKATOR = "*",
  Tid = "*"
)

# hent data
forv1 <- dst_get_data(table = "FORV1", query = forv_query, lang = "da")

# pivotere tabellen så den er nemmere at arbejde med
df_wide <- pivot_wider(
  forv1,
  names_from = INDIKATOR,   # dette bliver kolonnerne
  values_from = value )

names(df_wide)

# find indikator-kolonner (dem der starter med 'F' efterfulgt af tal)
indicator_cols <- names(df_wide)[str_detect(names(df_wide), "^F\\d+")]

# udtræk tallet (fx 10 fra 'F10 ...')
indicator_numbers <- as.numeric(str_extract(indicator_cols, "\\d+"))

# sorter navnene efter tallene
sorted_indicators <- indicator_cols[order(indicator_numbers)]

# byg dataframe med korrekt kolonnerækkefølge
df_wide <- df_wide %>%
  select(TID, all_of(sorted_indicators))

# filtrere på tid så vi kun har fra år 2000 og frem
df_wide <- df_wide %>% filter(TID >= "2000-01-01")


library(lubridate)

forv_kvt <- df_wide %>%
  mutate(
    TID = as.Date(TID),
    year = year(TID),
    quarter = quarter(TID),
    KVT = paste0(year, "K", quarter)
  )

forv_kvt_q <- forv_kvt %>%
  group_by(KVT) %>%
  summarise(
    across(
      where(is.numeric),
      mean,
      na.rm = TRUE
    )
  ) %>%
  arrange(KVT)



DST <- df_wide %>%
  mutate(
    TID = as.Date(TID),
    year = year(TID),
    quarter = quarter(TID),
    KVT = paste0(year, "K", quarter)
  ) %>%
  group_by(KVT) %>%
  summarise(
    F1 = mean(`F1 Forbrugertillidsindikatoren`, na.rm = TRUE)
  ) %>%
  arrange(KVT)


library(dplyr)

DST2 <- df_wide %>%
  arrange(TID) %>%
  mutate(
    kvartal_nr = (row_number() - 1) %/% 3,
    year = 2000 + kvartal_nr %/% 4,
    quarter = kvartal_nr %% 4 + 1,
    KVT = paste0(year, "K", quarter)
  ) %>%
  group_by(KVT) %>%
  summarise(
    F1 = mean(`F1 Forbrugertillidsindikatoren`, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(KVT)
head(DST2)
tail(DST2)

colnames(df_wide)



DI <- df_wide %>%
  arrange(TID) %>%
  mutate(
    kvartal_nr = (row_number() - 1) %/% 3,
    year = 2000 + kvartal_nr %/% 4,
    quarter = kvartal_nr %% 4 + 1,
    KVT = paste0(year, "K", quarter)
  ) %>%
  group_by(KVT) %>%
  summarise(
    DI = mean(
      c(
        `F2 Familiens økonomiske situation i dag, sammenlignet med for et år siden`,
        `F4 Danmarks økonomiske situation i dag, sammenlignet med for et år siden`,
        `F9 Anskaffelse af større forbrugsgoder, fordelagtigt for øjeblikket`,
        `F10 Anskaffelse af større forbrugsgoder, inden for de næste 12 mdr.`
      ),
      na.rm = TRUE
    ),
    .groups = "drop"
  ) %>%
  arrange(KVT)

data_all <- nkh %>%
  inner_join(DI, by = "KVT") %>%
  inner_join(DST2, by = "KVT")
data_all <- data_all %>%
  rename(DST = F1)

cor_DI  <- cor(data_all$realvækst, data_all$DI,  use = "complete.obs")
cor_DST <- cor(data_all$realvækst, data_all$DST,  use = "complete.obs")

cor_DI
cor_DST

model_DI <- lm(realvækst ~ DI, data = data_all)
summary(model_DI)$r.squared

model_DST <- lm(realvækst ~ DST, data = data_all)
summary(model_DST)$r.squared

resultater <- data.frame(
  Indikator = c("DI-FTI", "FTI (DST)"),
  Korrelation = c(0.6548409, 0.5715253),
  Forklaringsgrad = c(0.4288166, 0.3266411)
)

resultater
data_all %>% filter(KVT == "2025K4")

model_DI  <- lm(realvækst ~ DI,  data = data_all)
model_DST <- lm(realvækst ~ DST, data = data_all)
DI_2025K4  <- tail(data_all$DI, 1)
DST_2025K4 <- tail(data_all$DST, 1)
pred_DI_2025K4 <- predict(
  model_DI,
  newdata = data.frame(DI = DI_2025K4)
)
pred_DST_2025K4 <- predict(
  model_DST,
  newdata = data.frame(DST = DST_2025K4)
)
prognose_2025K4 <- data.frame(
  Kvartal = "2025K4",
  Indikator = c("DI", "DST"),
  Forudsagt_realvaekst_pct = c(pred_DI_2025K4, pred_DST_2025K4)
)

prognose_2025K4
summary(model_DI)
summary(model_DST)
