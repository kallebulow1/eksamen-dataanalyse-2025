### opgave 4.1 ###
library(dkstat)
library(tidyr)
library(ggplot2)
library(dplyr)
library(stringr)
library(lubridate)

# hent data fra dkstat
alkohol_meta <- dst_meta("FU02","da")

alkohol_query <- list(
  KONSUMGRP = c("02.1.1.1 Spiritus og likør","02.1.1.2 Alkoholiske læskedrikke","02.1.2.1 Vin af druer","02.1.2.2 Vin af andre frugter","02.1.2.3 Hedvin","02.1.2.4 Vinbaserede drikkevarer og alkoholfri vin","02.1.3.1 Pilsnerøl, guldøl","02.1.3.2 Andre alkoholholdige øl","02.1.3.3 Øl med lavt alkoholindhold og alkoholfri øl","02.1.3.4 Øl-baserede drikkevarer"),
  PRISENHED = "Faste priser",
  Tid = "*"
)

alkohol_raw <- dst_get_data("FU02",query = alkohol_query, lang = "da",meta_data = alkohol_meta)

alkohol_raw <- alkohol_raw[, -2]


alko_filter <- alkohol_raw %>%
  # 1) Filtrer år 2000 og frem
  filter(TID >= as.Date("2000-12-31")) %>%
  
  # 2) Behold kun årstal
  mutate(TID = lubridate::year(as.Date(TID))) %>%
  
  # 3) Fjern tal fra KONSUMGRP
  mutate(KONSUMGRP = gsub("[0-9.]", "", KONSUMGRP),   # fjern tal og punktummer
         KONSUMGRP = trimws(gsub(" +", " ", KONSUMGRP)))  # ryd op i mellemrum

# lave indekstal hvor startåret "2000" er baseline og indeks viser ændring i procent i forhold til baseline
indeks <- alko_filter %>% 
group_by(KONSUMGRP) %>% 
  mutate(
    base_2000 = value[TID == 2000],          # niveau i år 2000
    indeks    = value / base_2000 * 100     # 2000 = 100
  ) %>%
  ungroup()

# inddele de forksellige drikkevarer i kategori af samme type
grup_2 <- indeks %>%
  mutate(
    GRUPPE = case_when(
      # 1. Spiritus
      KONSUMGRP == "Spiritus og likør" ~ "Spiritus og likør",
      
      # 2. Vin samlet
      KONSUMGRP %in% c("Vin af druer",
                         "Vin af andre frugter",
                         "Hedvin") ~ "Vin (druer, andre frugter, hedvin)",
      
      # 3. Vinbaseret + lav/alkoholfri øl
      KONSUMGRP %in% c("Vinbaserede drikkevarer og alkoholfri vin",
                         "Øl med lavt alkoholindhold og alkoholfri øl") ~
        "Vinbaserede drikkevarer & lav/alkoholfri øl",
      
      # 4. Øl-gruppen
      KONSUMGRP %in% c("Pilsnerøl, guldøl",
                         "Andre alkoholholdige øl",
                         "Øl-baserede drikkevarer") ~
        "Øl (pilsner, andre, øl-baserede)",
      
      # 5. Alkoholiske læskedrikke
      KONSUMGRP == "Alkoholiske læskedrikke" ~ "Alkoholiske læskedrikke",
      
      TRUE ~ NA_character_
    )
  )

# summere de grupperet indekstal 
grup_2_sum <- grup_2 %>%
  group_by(GRUPPE, TID) %>%
  summarise(
    value = sum(value, na.rm = TRUE),
    .groups = "drop"
  )

# Nu laver vi indeks (2000=100) for de 5 nye grupper.
#Indeks per samlet gruppe, baseret på deres samlede niveau i år 2000.
gruppe_indeks <- grup_2_sum %>%
  group_by(GRUPPE) %>%
  mutate(
    base_value = value[TID == 2000],
    # hvis base = 0, find første positive værdi i gruppen
    base_value = ifelse(base_value == 0,
                        value[which(value > 0)][1],
                        base_value),
    indeks = value / base_value * 100
  ) %>%
  ungroup()

# Log-skalaen anvendes for at gøre udviklingen mere sammenlignelig på tværs af grupper.
# En logaritmisk akse viser procentvise ændringer frem for absolutte niveauer.
# Det betyder, at produktgrupper med små relative ændringer (fx vin og spiritus)
# fremstår mere stabile, mens grupper med kraftig vækst (fx alkoholiske læskedrikke)
# vises tydeligere uden at dominere figuren. Log-skalaen giver derfor et mere retvisende
# billede af forskelle i vækstrater mellem de samlede alkoholgrupper.
ggplot(gruppe_indeks,
       aes(x = TID, y = indeks, color = GRUPPE)) +
  geom_line(linewidth = 1) +
  scale_y_log10() +
  scale_x_continuous(breaks = seq(2000, 2022, by = 2)) +
  labs(
    title = "Indekseret udvikling i husholdningers alkoholudgifter over tid",
    x = "År",
    y = "Indeks (log-skala)",
    color = NULL
  ) +
  theme_minimal(base_size = 8) +
  theme(
    plot.title   = element_text(face = "bold", hjust = 0.5),
    axis.text.x  = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    legend.box   = "horizontal"
  )
